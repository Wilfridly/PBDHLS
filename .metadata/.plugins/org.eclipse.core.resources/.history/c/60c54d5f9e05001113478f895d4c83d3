/*
Temps Layer 1 : 1376 us
Temps Layer 2 : 2250699 us
Temps Layer 3 : 14218667 us
Temps Layer 4 : 9856711 us
Temps Layer 5 : 50675 us
*/

/* #include "xgpio.h"
#include "xil_printf.h"
#include "xil_types.h"
#include "xparameters.h"
#include "xtime_l.h" */

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <float.h>
#include <math.h>
// #include "timers_b.h"

/* #include "lw1.h"
#include "lw2.h"
#include "lw3.h"
#include "lw4.h" */

/* #define LED_ID XPAR_AXI_GPIO_LEDS_DEVICE_ID
#define LED_CHANNEL 1
#define LED_MASK 0b1111 */

// #define tour 1000

/* #define IMGWIDTH 29
#define IMGHEIGHT 29

#define SIGMOID(x) (1.7159*tanh(0.66666667*x))
#define DSIGMOID(S) (0.66666667/1.7159*(1.7159+(S))*(1.7159-(S))) */

void calculateLayer1(float* input, float* Layer1_Neurons_CPU);
void calculateLayer2(float* Layer1_Neurons_CPU, float* Layer2_Neurons_CPU);
void calculateLayer2(float Layer2_Neurons_CPU[], float Layer3_Neurons_CPU[]);
void l3(float Layer2_Neurons_CPU[], float Layer3_Neurons_CPU[]);
void calculateLayer4(float* Layer3_Neurons_CPU, float* Layer4_Neurons_CPU);
void calculateLayer5(float* Layer4_Neurons_CPU, double* Layer5_Neurons_CPU);

/* void calculateLayer1(float* input, float* Layer1_Neurons_CPU){
	memcpy(Layer1_Neurons_CPU, input, IMGWIDTH*IMGHEIGHT*sizeof(float));
}

void calculateLayer2(float* Layer1_Neurons_CPU, float* Layer2_Neurons_CPU){
		float somme;
	int i,j,k,m,n;
	for(i=0;i<6;i++)
		for(j=0;j<13;j++)
			for(k=0;k<13;k++){
				somme = Layer1_Weights_CPU[26*i];
				for(m=0;m<5;m++)
					for(n=0;n<5;n++)
						somme += Layer1_Weights_CPU[26*i+5*m+n+1] * Layer1_Neurons_CPU[29*(m+2*j)+n+2*k];
				Layer2_Neurons_CPU[13*13*i+13*j+k] = (float) SIGMOID(somme);
			}
}

void calculateLayer3(float* Layer2_Neurons_CPU, float* Layer3_Neurons_CPU){
#pragma HLS INTERFACE s_axilite port=Layer2_Neurons_CPU bundle=Layer2_Neurons_CPU
// #pragma HLS INTERFACE s_axilite port=Layer3_Neurons_CPU bundle=Layer3_Neurons_CPU

#pragma HLS ARRAY PARTITION variable=Layer2_Neurons_CPU type=block dim=2
// #pragma HLS ARRAY PARTITION variable=Layer3_Neurons_CPU type=block dim=2
// #pragma HLS UNROLL factor=4
#pragma HLS PIPELINE II=1
	float somme;
	int i,j,k,m,n;

	for( i=0;i<50;i++) {
		for(j=0;j<5;j++)
			for(k=0;k<5;k++){
				somme = Layer2_Weights_CPU[26*6*i];

				for( m=0;m<5;m++)
					LOOP5 : for( n=0;n<5;n++){
#pragma HLS unroll factor=5
						somme += Layer2_Weights_CPU[26*6*i+1+6*(n+5*m)	] * Layer2_Neurons_CPU[13*13*0+13*(2*j+m)+(2*k+n)];
						somme += Layer2_Weights_CPU[26*6*i+1+6*(n+5*m)+1] * Layer2_Neurons_CPU[13*13*1+13*(2*j+m)+(2*k+n)];
						somme += Layer2_Weights_CPU[26*6*i+1+6*(n+5*m)+2] * Layer2_Neurons_CPU[13*13*2+13*(2*j+m)+(2*k+n)];
						somme += Layer2_Weights_CPU[26*6*i+1+6*(n+5*m)+3] * Layer2_Neurons_CPU[13*13*3+13*(2*j+m)+(2*k+n)];
						somme += Layer2_Weights_CPU[26*6*i+1+6*(n+5*m)+4] * Layer2_Neurons_CPU[13*13*4+13*(2*j+m)+(2*k+n)];
						somme += Layer2_Weights_CPU[26*6*i+1+6*(n+5*m)+5] * Layer2_Neurons_CPU[13*13*5+13*(2*j+m)+(2*k+n)];

					}
				Layer3_Neurons_CPU[5*5*i+5*j+k] = (float) SIGMOID(somme);
			}
	}
}

void calculateLayer4(float* Layer3_Neurons_CPU, float* Layer4_Neurons_CPU){
	float somme;
	int i, j, k, m;
	for( i=0;i<100;i++){
		somme = Layer3_Weights_CPU[i*(1+50*25)];
		for( j=0;j<50;j++)
			for( k=0;k<5;k++)
				for ( m=0;m<5;m++)
					somme += Layer3_Weights_CPU[i*(1+50*25)+1 + m + k*5 + j*25] * Layer3_Neurons_CPU[m+5*k+25*j];

		Layer4_Neurons_CPU[i] = (float) SIGMOID(somme);
	}

}

void calculateLayer5(float* Layer4_Neurons_CPU, double* Layer5_Neurons_CPU){
	float somme;
	int i, j;
	for( i=0;i<10;i++){
		somme = Layer4_Weights_CPU[101*i];
		for( j=0;j<100;j++)
			somme += Layer4_Weights_CPU[1+101*i+j] * Layer4_Neurons_CPU[j];
		Layer5_Neurons_CPU[i] = SIGMOID(somme);
	}
} */
